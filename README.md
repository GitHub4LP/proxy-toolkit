# ç«¯å£ç®¡ç†æœåŠ¡ (Proxy Toolkit)

ä¸€ä¸ªé¢å‘å­è·¯å¾„ä»£ç†ç¯å¢ƒçš„ç«¯å£è®¿é—®ä¸å¯¼èˆªä¿®å¤å·¥å…·ï¼Œè‡ªåŠ¨æ¢æµ‹å¹³å°ä»£ç†æ¨¡æ¿ã€ç”Ÿæˆç«¯å£ä»£ç†é“¾æ¥ï¼Œå¹¶æä¾›ç»Ÿä¸€çš„ Service Workerï¼ˆå­è·¯å¾„ä¿®å¤æˆ– HTTP éš§é“ï¼‰ä»¥æå‡åœ¨ JupyterLabã€Code Serverã€AI Studio ç­‰ç¯å¢ƒä¸‹çš„å¯ç”¨æ€§ã€‚

## æ ¸å¿ƒç‰¹æ€§

### ğŸ” æ™ºèƒ½ç¯å¢ƒæ£€æµ‹
- è‡ªåŠ¨è¯†åˆ«è¿è¡Œç¯å¢ƒï¼šJupyterLabã€Code Serverã€AI Studio
- ä»£ç†URLæ¨¡æ¿ç”Ÿæˆï¼šè¿”å›æœ€çŸ­å­è·¯å¾„æ¨¡æ¿ï¼ˆå¦‚ `/proxy/{{port}}/` æˆ–å¹³å°å˜é‡æ‹¼æ¥ï¼‰
- nginxè§£ç æ·±åº¦è¾…åŠ©æ£€æµ‹ï¼šå‰ç«¯æ¢æµ‹ä»£ç†å±‚å¯¹å‚æ•°çš„è§£ç æ·±åº¦ï¼ˆç”¨äºå­è·¯å¾„ç­–ç•¥ç¼–ç è¡¥å¿ï¼‰

### ğŸ–¥ï¸ ç«¯å£ç›‘æ§ç®¡ç†
- å®æ—¶æ£€æµ‹ç«¯å£ç›‘å¬çŠ¶æ€ï¼ˆTCP connect_exï¼‰
- å±•ç¤ºè¿›ç¨‹ä¿¡æ¯ï¼ˆPIDã€å®Œæ•´å‘½ä»¤è¡Œï¼‰
- æ™ºèƒ½å¢é‡æ›´æ–°ï¼šåªæ›´æ–°å˜åŒ–çš„ç«¯å£ï¼Œä¿æŠ¤ç”¨æˆ·äº¤äº’
- æ•°æ®æºï¼šSW registrationsï¼ˆæµè§ˆå™¨æŒä¹…åŒ–ï¼‰
- åç«¯ LRU ç¼“å­˜ï¼šè‡ªåŠ¨æ·˜æ±°ä¸å¸¸ç”¨ç«¯å£

### ğŸ”§ ç»Ÿä¸€Service Workerï¼ˆåŠ¨æ€é…ç½®ï¼‰
- **åŠ¨æ€ç­–ç•¥åˆ‡æ¢**ï¼šé€šè¿‡ `postMessage` å®æ—¶é…ç½®ç­–ç•¥
- **å››ç§æ¨¡å¼**ï¼š
  - Noneï¼šä¸å¤„ç†ä»»ä½•è¯·æ±‚ï¼ˆé»˜è®¤ï¼‰
  - Subpathï¼šä¿®æ­£è¯·æ±‚è·¯å¾„å‰ç¼€ä¸å¤šå±‚ç¼–ç é”™ä½
  - Tunnelï¼šæ”¹å†™è¯·æ±‚åˆ°åç«¯ HTTP éš§é“é€ä¼ 
  - Hybridï¼šæ™ºèƒ½æ··åˆï¼ˆå¤§éƒ¨åˆ†èµ° Subpathï¼ŒåŒ…å« `%2F` çš„èµ° Tunnelï¼‰
- **å¯¼èˆªæ‹¦æˆªå™¨**ï¼šè‡ªåŠ¨æ³¨å…¥è„šæœ¬ï¼Œä¿®å¤å­è·¯å¾„ç¯å¢ƒä¸‹çš„å¯¼èˆªè¡Œä¸º
- **è‡ªåŠ¨æ³¨å†Œ**ï¼šæ·»åŠ ç«¯å£æ—¶è‡ªåŠ¨æ³¨å†Œ SW

## é¡¹ç›®æ¶æ„

### æ ¸å¿ƒæ¨¡å—

#### 1. server.py â€” ä¸»æœåŠ¡ï¼ˆaiohttpï¼‰
- è·¯ç”±ï¼š
  - GET `/` é™æ€é¦–é¡µ
  - GET `/api/port/{port}` å•ç«¯å£æŸ¥è¯¢ï¼ˆLRU ç¼“å­˜ï¼Œæœ€å¤š 100 ä¸ªï¼‰
  - GET `/api/url-template` ç¯å¢ƒ URL æ¨¡æ¿
  - GET `/api/test-encoding/{path:.*}` åŸå§‹è·¯å¾„ï¼ˆç”¨äºç¼–ç æ£€æµ‹ï¼‰
  - ANY `/api/http-tunnel/{port}` HTTP éš§é“é€ä¼ 
  - GET `/unified_service_worker.js` ç»Ÿä¸€ SW è„šæœ¬
  - GET `/navigation_interceptor.js` å¯¼èˆªæ‹¦æˆªå™¨
  - `/static/*` é™æ€èµ„æº
- ç«¯å£ä¸è¿›ç¨‹ï¼špsutil.net_connections å®šä½è¿›ç¨‹ï¼Œè¿”å› PID/åç§°/å®Œæ•´ cmdline
- LRU ç¼“å­˜ï¼šè‡ªåŠ¨æ·˜æ±°ä¸å¸¸ç”¨ç«¯å£ï¼Œæ— éœ€æ˜¾å¼åˆ é™¤
- å¯åŠ¨æ¡ä»¶ï¼šä»…åœ¨æ£€æµ‹åˆ°å­è·¯å¾„ç¯å¢ƒæ—¶å¯åŠ¨

#### 2. port_proxy.py â€” ç¯å¢ƒæ£€æµ‹ä¸æ¨¡æ¿ç”Ÿæˆ
- JupyterLabï¼šæšä¸¾è¿è¡Œä¸­çš„æœåŠ¡å™¨ï¼Œè¿”å› `base_url + proxy/{{port}}/`
- Code Serverï¼šè¯»å–ç¯å¢ƒå˜é‡ `VSCODE_PROXY_URI`
- AI Studioï¼šæ‹¼æ¥ `STUDIO_MODEL_API_URL_PREFIX + JUPYTERHUB_SERVICE_PREFIX + gradio/{{port}}/`
- detect_service_configï¼šè¯†åˆ«æœåŠ¡ç±»å‹ï¼Œè¿”å›è·¯å¾„æ®µæ•°æœ€çŸ­çš„æ¨¡æ¿
- generate_proxy_url(port)ï¼šç”¨æ¨¡æ¿æ›¿æ¢ `{{port}}`

#### 3. main.gradio.py â€” Gradioç¯å¢ƒå¯åŠ¨å™¨
- è‡ªåŠ¨å®‰è£…ä¾èµ–ï¼ˆaiohttpã€jupyter-serverã€psutilã€requestsï¼‰
- ä»¥ `GRADIO_SERVER_PORT`ï¼ˆé»˜è®¤7860ï¼‰å¯åŠ¨ `PortServer`ï¼Œä¸åšå­è·¯å¾„æ£€æŸ¥

#### 4. å‰ç«¯ï¼ˆstatic/ï¼‰
- **index.html / style.css**ï¼šVSCode é£æ ¼ç«¯å£ç®¡ç†ç•Œé¢
- **app.js**ï¼š
  - æ•°æ®æºï¼šä» SW registrations è¯»å–ç«¯å£åˆ—è¡¨
  - æ™ºèƒ½å¢é‡æ›´æ–°ï¼šåªæ›´æ–°å˜åŒ–çš„ç«¯å£è¡Œï¼Œä¿æŠ¤ç”¨æˆ·äº¤äº’
  - ç¼–ç æ£€æµ‹ï¼šè‡ªåŠ¨æ£€æµ‹åŸºå‡†è§£ç æ·±åº¦å’Œ `%2F` ç‰¹æ®Šè§£ç 
  - ç­–ç•¥åˆ‡æ¢ï¼šé€šè¿‡ `postMessage` åŠ¨æ€é…ç½® SW
  - å¿«é€Ÿåˆ é™¤ï¼šç«‹å³æ¸…ç†å‰ç«¯çŠ¶æ€ï¼Œå¼‚æ­¥æ³¨é”€ SW

#### 5. æµè§ˆå™¨è„šæœ¬
- **unified_service_worker.js**ï¼šç»Ÿä¸€ SW è„šæœ¬
  - æ”¯æŒå››ç§ç­–ç•¥ï¼šNone/Subpath/Tunnel/Hybrid
  - é€šè¿‡ `postMessage` åŠ¨æ€é…ç½®
  - Hybrid æ¨¡å¼ï¼šæ ¹æ®è·¯å¾„å†…å®¹æ™ºèƒ½è·¯ç”±
  - å¯¼èˆªæ‹¦æˆªå™¨æ³¨å…¥
- **navigation_interceptor.js**ï¼šä¿®æ­£å­è·¯å¾„å¯¼èˆªè¡Œä¸º

## å…³é”®ç®—æ³•

### ç¼–ç æ·±åº¦æ£€æµ‹
```javascript
// 1. åŸºå‡†æ·±åº¦æ£€æµ‹ï¼ˆä½¿ç”¨ç©ºæ ¼ï¼Œé¿å… %2F å¹²æ‰°ï¼‰
const testSegment = "test path";  // â†’ "test%20path"
// å‘é€å¤šå±‚ç¼–ç ï¼Œé€šè¿‡åå‘ç¼–ç è®¡ç®—è§£ç æ·±åº¦

// 2. %2F ç‰¹æ®Šè§£ç æ£€æµ‹
const testSegment = "test/path";  // â†’ "test%2Fpath"
// å¦‚æœåç«¯è¿”å› "test/path"ï¼ˆåŒ…å«çœŸå®æ–œæ ï¼‰ï¼Œè¯´æ˜ %2F è¢«é¢å¤–è§£ç 
```

### æ™ºèƒ½å¢é‡æ›´æ–°
```javascript
// åªæ›´æ–°å˜åŒ–çš„ç«¯å£è¡Œï¼Œä¿æŠ¤ç”¨æˆ·äº¤äº’
displayPorts(ports) {
    // æ£€æµ‹ç”¨æˆ·æ˜¯å¦æ­£åœ¨æ“ä½œ
    if (document.activeElement.tagName === 'SELECT') {
        return; // è·³è¿‡æ›´æ–°ï¼Œé¿å…æ‰“æ–­
    }
    
    // å¢é‡æ›´æ–°ï¼šåªæ·»åŠ /åˆ é™¤/æ›´æ–°å˜åŒ–çš„è¡Œ
    allPorts.forEach(port => {
        const existingRow = tbody.querySelector(`tr[data-port="${port.port}"]`);
        if (!existingRow) {
            tbody.appendChild(createRow(port)); // æ–°ç«¯å£
        } else {
            updateRowIfNeeded(existingRow, port); // åªæ›´æ–°å˜åŒ–çš„å•å…ƒæ ¼
        }
    });
}
```

### Hybrid ç­–ç•¥æ™ºèƒ½è·¯ç”±
```javascript
// SW ä¸­æ ¹æ®è·¯å¾„å†…å®¹åŠ¨æ€é€‰æ‹©å¤„ç†æ–¹å¼
if (strategy === 'hybrid') {
    if (slashExtraDecoding && /%2F/i.test(pathname)) {
        TunnelHandler.handleFetch(event);  // åŒ…å« %2F èµ° Tunnel
    } else {
        SubpathHandler.handleFetch(event); // å…¶ä»–èµ° Subpath
    }
}
```

## APIæ¥å£

```
GET     /                              # ä¸»ç•Œé¢
GET     /api/port/{port}               # å•ç«¯å£ä¿¡æ¯ï¼ˆåç«¯ LRU ç¼“å­˜ï¼‰
GET     /api/url-template              # ä»£ç†æ¨¡æ¿ä¸æ”¯æŒæ ‡è®°
GET     /api/test-encoding/{path}      # è¿”å›åŸå§‹è·¯å¾„ï¼ˆç”¨äºç¼–ç æ£€æµ‹ï¼‰
*       /api/http-tunnel/{port}?u=/... # HTTP éš§é“é€ä¼ 
GET     /unified_service_worker.js     # ç»Ÿä¸€ SW è„šæœ¬
GET     /navigation_interceptor.js     # å¯¼èˆªæ‹¦æˆªå™¨
GET     /static/*                      # é™æ€èµ„æº
```



## ä»£ç†ç­–ç•¥

| ç­–ç•¥ | é€‚ç”¨åœºæ™¯ | åŸç† | ä¼˜åŠ¿ |
|------|---------|------|------|
| **None** | ç«¯å£æœåŠ¡å·²æ­£ç¡®å¤„ç†å­è·¯å¾„ | ä¸å¤„ç†ä»»ä½•è¯·æ±‚ | é›¶å¼€é”€ |
| **Subpath** | æ ‡å‡†å­è·¯å¾„ä»£ç† | ä¿®æ­£è·¯å¾„å‰ç¼€ä¸ç¼–ç é”™ä½ | è½»é‡ã€é«˜æ€§èƒ½ |
| **Tunnel** | å¤æ‚ä»£ç†ç¯å¢ƒ | æ”¹å†™ä¸ºåç«¯éš§é“é€ä¼  | è¦†ç›–é¢å¹¿ |
| **Hybrid** | `%2F` è¢«ç‰¹æ®Šè§£ç çš„ç¯å¢ƒ | æ™ºèƒ½è·¯ç”±ï¼ˆæ™®é€šèµ° Subpathï¼Œ`%2F` èµ° Tunnelï¼‰ | å…¼é¡¾æ€§èƒ½ä¸å…¼å®¹æ€§ |

## ä½¿ç”¨æ–¹å¼

### æ ‡å‡†ç¯å¢ƒ
```bash
python server.py --host 0.0.0.0 --port 3000
# ä»…åœ¨æ£€æµ‹åˆ°å­è·¯å¾„ç¯å¢ƒæ—¶å¯åŠ¨
```

### Gradio ç¯å¢ƒ
```bash
python main.gradio.py
# é»˜è®¤ç«¯å£ 7860ï¼Œå¯é€šè¿‡ GRADIO_SERVER_PORT ç¯å¢ƒå˜é‡æŒ‡å®š
```

### ä¾èµ–
```bash
pip install -r requirements.txt
```
